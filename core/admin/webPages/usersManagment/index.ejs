<!-- TEMPLTE PER LA CREAZIONE DELLEE PAGINE DI AMMINISTRAZIONE  -->
<!-- NOTA: Usa getThemePartPath() con passData per caricare automaticamente i partial del tema admin
<%- include( passData.themeSys.getThemePartPath( 'head.ejs', passData ) ) %>
<%- include( passData.themeSys.getThemePartPath( 'header.ejs', passData ) ) %>

<!-- api prefix -->
<span id="apiPrefix" style="display: none;"><%- passData.apiPrefix %></span>
<script>
    const apiPrefix = document.getElementById('apiPrefix').innerText;
</script>

<!-- adminPrefix -->
<span id="adminPrefix" style="display: none;"><%- passData.adminPrefix %></span>
<script>
    const adminPrefix = document.getElementById('adminPrefix').innerText;
</script>

<h3>Gestione utenti : </h3>

<div class="container mt-4">
    <h2>Lista Utenti</h2>
    <div id="userList" class="list-group">
        <!-- User list will be populated here -->
    </div>
</div>

<script>
    async function loadUserList() {
        const userList = document.getElementById('userList');
        userList.innerHTML = ''; // Clear the list before populating
        //const roleSelect = document.getElementById('role');
        //roleSelect.innerHTML = ''; // Clear the select options before populating

        try {
            // Fetch user list
            const userResponse = await fetch(`/${apiPrefix}/simpleAccess/userList`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!userResponse.ok) {
                throw new Error(`HTTP error! status: ${userResponse.status}`);
            }

            const users = await userResponse.json();

            // Fetch role list
            const roleResponse = await fetch(`/${apiPrefix}/simpleAccess/roleList`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!roleResponse.ok) {
                throw new Error(`HTTP error! status: ${roleResponse.status}`);
            }

            const rolesData = await roleResponse.json();
            const roles = rolesData.roles;

            // Populate role select dropdown
/*             if (roles && Object.keys(roles).length > 0) {
                Object.keys(roles).forEach(roleId => {
                    const roleOption = document.createElement('option');
                    roleOption.value = roleId;
                    roleOption.textContent = roles[roleId].name;
                    roleSelect.appendChild(roleOption);
                });
            } else {
                const noRoleOption = document.createElement('option');
                noRoleOption.value = "";
                noRoleOption.textContent = "Nessun ruolo disponibile";
                noRoleOption.disabled = true;
                roleSelect.appendChild(noRoleOption);
            } */

            // Populate user list
            if (Array.isArray(users) && users.length > 0) {
                users.forEach(user => {
                    const userContainer = document.createElement('div');
                    userContainer.className = "list-group-item";

                    const roleName = roles[user.roleId] ? roles[user.roleId].name : 'Ruolo sconosciuto';

                    userContainer.innerHTML = `
                        <p><strong>Username:</strong> ${user.username}</p>
                        <p><strong>Role:</strong> ${roleName}</p>
                        <div class="text-start">
                            <a href="/${adminPrefix}/usersManagment/userView.ejs?username=${user.username}" class="btn btn-info btn-sm me-2">Visualizza</a>
                            <a href="/${adminPrefix}/usersManagment/userUpsert.ejs?username=${user.username}" class="btn btn-warning btn-sm me-2">Modifica</a>
                            <a href="/${adminPrefix}/usersManagment/userDelete.ejs?username=${user.username}" class="btn btn-danger btn-sm">Elimina</a>
                        </div>
                    `;

                    userList.appendChild(userContainer);
                });
            } else {
                userList.innerHTML = '<p class="text-danger">Nessun utente trovato.</p>';
            }
        } catch (error) {
            console.error('Errore:', error);
            userList.innerHTML = '<p class="text-danger">Errore nel recupero della lista utenti o ruoli.</p>';
        }
    }
    document.addEventListener("DOMContentLoaded", loadUserList);

</script>



<div class="container mt-4">
    <!-- <button id="createUserBtn" class="btn btn-primary">
        <i class="bi bi-plus"></i> Crea Utente
    </button> -->

    <a href="/<%- passData.adminPrefix %>/usersManagment/userUpsert.ejs" class="btn btn-primary">Crea nuovo Utente</a>

<!--     <form id="createUserForm" class="mt-3" style="display: none;">
        <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" placeholder="Inserisci username" required>
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" placeholder="Inserisci email" required>
        </div>
        <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password" placeholder="Inserisci password" required>
        </div>
        <div class="mb-3">
            <label for="role" class="form-label">Ruolo</label>
            <select class="form-select" id="role" required>
                <option value="" disabled selected>Seleziona un ruolo</option>
                <!-- Options will be dynamically populated --> <!--
            </select>
        </div>
        <button type="submit" class="btn btn-success">Salva</button>
    </form> -->

</div>

<script>
    /* document.getElementById('createUserBtn').addEventListener('click', function () {//questo evento rende visibile il form
        const form = document.getElementById('createUserForm');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    });

    document.getElementById('createUserForm').addEventListener('submit', async function (event) {
        event.preventDefault();

        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const roleId = document.getElementById('role').value;

        //console.log('{ username, email, password, roleId }', { username, email, password, roleId });

        try {
            const response = await fetch(`/${apiPrefix}/simpleAccess/createUser`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, email, password, roleId })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                const successMessage = document.createElement('div');
                successMessage.id = 'successMessage';
                successMessage.className = 'alert alert-success mt-3';
                successMessage.textContent = result.success; //qui conterrÃ  il messaggio di successo
                document.getElementById('createUserForm').style.display = 'none';
                document.getElementById('createUserForm').after(successMessage);
                const existingErrorMessage = document.getElementById('errorMessage');// cancello eventuali messaggi di errore precedenti 
                if (existingErrorMessage) {
                    existingErrorMessage.textContent = '';
                }               
                loadUserList(); // Ricarica la lista utenti
            } else if (result.error) {
                const errorMessage = document.createElement('div');
                errorMessage.id = 'errorMessage';
                errorMessage.className = 'alert alert-danger mt-3';
                errorMessage.textContent = result.error; // Messaggio di errore
                document.getElementById('createUserForm').after(errorMessage);

                if (result.errorType === 'all') {
                    // Evidenzia tutti i campi
                    ['username', 'email', 'password', 'role'].forEach(field => {
                        const inputField = document.getElementById(field);
                        if (inputField) {
                            inputField.classList.add('is-invalid');
                        }
                    });
                } else {
                    // Evidenzia solo il campo specifico
                    const inputField = document.getElementById(result.errorType);
                    if (inputField) {
                        inputField.classList.add('is-invalid');
                    }
                }
            } else {
                throw new Error('Errore sconosciuto.');
            }
            //alert('Utente creato con successo!');
            document.getElementById('createUserForm').reset();
            document.getElementById('createUserForm').style.display = 'none';
        } catch (error) {
            console.error('Errore:', error);
            alert('Errore nella creazione dell\'utente. error: ' + error.message);
        }
    }); */
</script>


<%- include( passData.themeSys.getThemePartPath( 'footer.ejs', passData ) ) %>