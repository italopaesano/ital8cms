<!-- GESTIONE TEMI - Lista e attivazione temi per sito pubblico e admin -->
<!-- ATTENZIONE nelle pagine di admin sarÃ  chiamata la funzione getAdminThemePartPath() e non la funzione getThemePartPath() -->
<%- include( passData.themeSys.getAdminThemePartPath( 'head.ejs' ) ) %>
<%- include( passData.themeSys.getAdminThemePartPath( 'header.ejs' ) ) %>

<!-- api prefix -->
<span id="apiPrefix" style="display: none;"><%- passData.apiPrefix %></span>
<script>
    const apiPrefix = document.getElementById('apiPrefix').innerText;
</script>

<!-- adminPrefix -->
<span id="adminPrefix" style="display: none;"><%- passData.adminPrefix %></span>
<script>
    const adminPrefix = document.getElementById('adminPrefix').innerText;
</script>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-palette"></i> Gestione Temi</h2>
        <a href="/<%= passData.adminPrefix %>" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Torna alla Dashboard
        </a>
    </div>

    <!-- Alert messaggi -->
    <div id="alert-container"></div>

    <!-- Configurazione Attuale -->
    <div class="row mb-4" id="current-themes">
        <!-- Caricato dinamicamente via JavaScript -->
    </div>

    <!-- Lista Temi Disponibili -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-collection"></i> Temi Disponibili (<span id="themes-count">-</span>)</h5>
        </div>
        <div class="card-body" id="themes-list">
            <!-- Loading spinner -->
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Caricamento...</span>
                </div>
                <p class="mt-2 text-muted">Caricamento temi...</p>
            </div>
        </div>
    </div>

    <!-- Legenda -->
    <div class="mt-3">
        <small class="text-muted">
            <span class="badge bg-primary"><i class="bi bi-globe"></i></span> Tema pubblico attivo |
            <span class="badge bg-success"><i class="bi bi-gear"></i></span> Tema admin attivo
        </small>
    </div>
</div>

<!-- Modal Conferma Attivazione -->
<div class="modal fade" id="activateThemeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Conferma Attivazione Tema</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="activateThemeMessage"></p>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Nota:</strong> Per applicare il nuovo tema, potrebbe essere necessario riavviare il server.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="confirmActivateBtn">
                    <i class="bi bi-check"></i> Conferma
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let pendingTheme = null;
let pendingType = null;
let currentPublicTheme = null;
let currentAdminTheme = null;

// Carica temi all'avvio
window.addEventListener('DOMContentLoaded', loadThemes);

async function loadThemes() {
    try {
        const response = await fetch(`/${apiPrefix}/admin/themes`);
        const result = await response.json();

        if (result.success) {
            const themes = result.themes;

            // Trova i temi attivi correnti
            currentPublicTheme = themes.find(t => t.isActivePublic)?.name || 'default';
            currentAdminTheme = themes.find(t => t.isActiveAdmin)?.name || 'default';

            // Mostra configurazione attuale
            displayCurrentThemes(currentPublicTheme, currentAdminTheme);

            // Mostra lista temi
            displayThemesList(themes);

            document.getElementById('themes-count').textContent = themes.length;
        } else {
            showAlert('danger', 'Errore nel caricamento dei temi: ' + result.error);
        }
    } catch (error) {
        console.error('Errore:', error);
        showAlert('danger', 'Errore nella richiesta: ' + error.message);
    }
}

function displayCurrentThemes(publicTheme, adminTheme) {
    const html = `
        <div class="col-md-6">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-globe"></i> Tema Sito Pubblico
                </div>
                <div class="card-body">
                    <h5 class="card-title">${escapeHtml(publicTheme)}</h5>
                    <p class="card-text text-muted">Tema attualmente attivo per le pagine pubbliche del sito.</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-gear"></i> Tema Admin Panel
                </div>
                <div class="card-body">
                    <h5 class="card-title">${escapeHtml(adminTheme)}</h5>
                    <p class="card-text text-muted">Tema attualmente attivo per il pannello di amministrazione.</p>
                </div>
            </div>
        </div>
    `;
    document.getElementById('current-themes').innerHTML = html;
}

function displayThemesList(themes) {
    if (themes.length === 0) {
        document.getElementById('themes-list').innerHTML = `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i> Nessun tema trovato nella cartella themes/
            </div>
        `;
        return;
    }

    let html = '<div class="row">';

    themes.forEach(theme => {
        html += createThemeCard(theme);
    });

    html += '</div>';
    document.getElementById('themes-list').innerHTML = html;
}

function createThemeCard(theme) {
    const isPublicActive = theme.isActivePublic;
    const isAdminActive = theme.isActiveAdmin;
    const borderClass = isPublicActive ? 'border-primary' : (isAdminActive ? 'border-success' : '');

    return `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 ${borderClass}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>${escapeHtml(theme.name)}</strong>
                    <span>
                        ${isPublicActive ? '<span class="badge bg-primary" title="Tema pubblico attivo"><i class="bi bi-globe"></i></span>' : ''}
                        ${isAdminActive ? '<span class="badge bg-success" title="Tema admin attivo"><i class="bi bi-gear"></i></span>' : ''}
                    </span>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small">
                        <li>
                            ${theme.valid ? '<i class="bi bi-check-circle text-success"></i>' : '<i class="bi bi-x-circle text-danger"></i>'}
                            Struttura ${theme.valid ? 'valida' : 'non valida'}
                        </li>
                        <li>
                            <i class="bi bi-file-earmark-code"></i>
                            Views: ${theme.filesCount.views}, Templates: ${theme.filesCount.templates}
                        </li>
                        <li>
                            ${theme.config.isInstalled ? '<i class="bi bi-check-circle text-success"></i> Installato' : '<i class="bi bi-x-circle text-danger"></i> Non installato'}
                        </li>
                        ${theme.dependencies.satisfied === false ? `<li class="text-warning"><i class="bi bi-exclamation-triangle"></i> Dipendenze non soddisfatte</li>` : ''}
                    </ul>
                    ${theme.description?.description ? `<p class="card-text small text-muted">${escapeHtml(theme.description.description.substring(0, 80))}${theme.description.description.length > 80 ? '...' : ''}</p>` : ''}
                </div>
                <div class="card-footer">
                    <div class="btn-group btn-group-sm w-100" role="group">
                        <a href="/${adminPrefix}/themesManagment/themeView.ejs?theme=${encodeURIComponent(theme.name)}"
                           class="btn btn-outline-info" title="Visualizza dettagli">
                            <i class="bi bi-eye"></i> Dettagli
                        </a>
                        ${!isPublicActive ? `
                            <button type="button"
                                    class="btn btn-outline-primary"
                                    onclick="activateTheme('${escapeHtml(theme.name)}', 'public')"
                                    title="Imposta come tema pubblico">
                                <i class="bi bi-globe"></i>
                            </button>
                        ` : ''}
                        ${!isAdminActive ? `
                            <button type="button"
                                    class="btn btn-outline-success"
                                    onclick="activateTheme('${escapeHtml(theme.name)}', 'admin')"
                                    title="Imposta come tema admin">
                                <i class="bi bi-gear"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
}

function activateTheme(themeName, themeType) {
    pendingTheme = themeName;
    pendingType = themeType;

    const typeLabel = themeType === 'public' ? 'sito pubblico' : 'pannello admin';
    const message = `Vuoi attivare il tema "<strong>${escapeHtml(themeName)}</strong>" per il ${typeLabel}?`;

    document.getElementById('activateThemeMessage').innerHTML = message;

    const modal = new bootstrap.Modal(document.getElementById('activateThemeModal'));
    modal.show();
}

document.getElementById('confirmActivateBtn').addEventListener('click', async function() {
    if (!pendingTheme || !pendingType) return;

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Attivazione...';

    try {
        const response = await fetch(`/${apiPrefix}/admin/setTheme`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                themeName: pendingTheme,
                themeType: pendingType
            })
        });

        const result = await response.json();

        if (result.success) {
            showAlert('success', result.message || 'Tema attivato con successo!');

            // Ricarica la lista dopo 2 secondi
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showAlert('danger', 'Errore: ' + (result.error || 'Impossibile attivare il tema'));
        }
    } catch (error) {
        console.error('Errore:', error);
        showAlert('danger', 'Errore nella richiesta: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check"></i> Conferma';
        bootstrap.Modal.getInstance(document.getElementById('activateThemeModal')).hide();
    }
});

function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            <div>${message}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.getElementById('alert-container').innerHTML = alertHtml;
    window.scrollTo(0, 0);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>

<%- include( passData.themeSys.getAdminThemePartPath( 'footer.ejs' ) ) %>
