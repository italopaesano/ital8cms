<!-- TEMPLATE PER LA CREAZIONE DELLE PAGINE DI AMMINISTRAZIONE  -->
<!-- NOTA: Usa getThemePartPath() con passData (che contiene isAdminContext: true) -->
<!--       per caricare automaticamente i partial del tema admin -->
<%- include( passData.themeSys.getThemePartPath( 'head.ejs', passData ) ) %>
<%- include( passData.themeSys.getThemePartPath( 'header.ejs', passData ) ) %>

<!-- api prefix -->
<span id="apiPrefix" style="display: none;"><%- passData.apiPrefix %></span>
<script>
    const apiPrefix = document.getElementById('apiPrefix').innerText;
</script>

<!-- adminPrefix -->
<span id="adminPrefix" style="display: none;"><%- passData.adminPrefix %></span>
<script>
    const adminPrefix = document.getElementById('adminPrefix').innerText;
</script>

<div class="container mt-5">
    <!-- Loading Spinner -->
    <div id="loading-spinner" class="text-center my-5">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Caricamento...</span>
        </div>
        <p class="mt-3 text-muted">Caricamento sezioni admin...</p>
    </div>

    <!-- Contenuto dashboard (nascosto durante caricamento) -->
    <div id="dashboard-content" class="row" style="display: none;">
        <div class="col-md-3">
            <div class="list-group" id="menu-container">
                <!-- Menu generato via JavaScript -->
            </div>
        </div>
        <div class="col-md-9">
            <div class="card">
                <div class="card-header" id="welcome-message">
                    <!-- Welcome message generato via JavaScript -->
                </div>
                <div class="card-body">
                    <h5 class="card-title">Seleziona un'opzione dal menu</h5>
                    <p class="card-text">Utilizza il menu a sinistra per navigare tra le opzioni di gestione.</p>

                    <div id="sections-list">
                        <!-- Lista sezioni generata via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error message (nascosto di default) -->
    <div id="error-container" class="alert alert-danger" style="display: none;" role="alert">
        <h4 class="alert-heading">Errore di caricamento</h4>
        <p id="error-message"></p>
    </div>
</div>

<script>
// Carica sezioni admin via API
async function loadAdminSections() {
    try {
        const response = await fetch(`/${apiPrefix}/admin/${adminPrefix}/sections`);

        if (!response.ok) {
            if (response.status === 401) {
                throw new Error('Non autenticato. Effettua il login.');
            }
            throw new Error(`Errore HTTP: ${response.status}`);
        }

        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error || 'Errore sconosciuto');
        }

        // Renderizza dashboard con i dati ricevuti
        renderDashboard(result.data);

    } catch (error) {
        console.error('Error loading admin sections:', error);
        showError(error.message);
    }
}

function renderDashboard(data) {
    const { ui, sections } = data;

    // Renderizza menu header
    const menuContainer = document.getElementById('menu-container');
    let menuHTML = `
        <a href="/${adminPrefix}/" class="list-group-item list-group-item-action active" aria-current="true">
            ${ui.title}
        </a>
    `;

    // Renderizza sezioni menu
    if (sections.length > 0) {
        sections.forEach(section => {
            const icon = section.icon ? `<span class="me-2">${section.icon}</span>` : '';
            const title = section.type === 'plugin'
                ? `Fornito da plugin: ${section.plugin}`
                : 'Sezione integrata';

            menuHTML += `
                <a href="${section.url}" class="list-group-item list-group-item-action" title="${title}">
                    ${icon}${section.label}
                </a>
            `;
        });
    } else {
        menuHTML += `
            <div class="list-group-item text-muted">
                <small>Nessuna sezione admin disponibile</small>
            </div>
        `;
    }

    menuContainer.innerHTML = menuHTML;

    // Renderizza welcome message
    document.getElementById('welcome-message').textContent = ui.welcomeMessage;

    // Renderizza lista sezioni nel content area
    const sectionsList = document.getElementById('sections-list');
    if (sections.length > 0) {
        let sectionsHTML = '<hr><h6>Sezioni disponibili:</h6><ul class="list-unstyled">';

        sections.forEach(section => {
            const badge = section.type === 'plugin'
                ? `<span class="badge bg-primary ms-2">Plugin: ${section.plugin}</span>`
                : `<span class="badge bg-secondary ms-2">Integrato</span>`;

            sectionsHTML += `
                <li class="mb-2">
                    <strong>${section.icon} ${section.label}</strong>
                    ${badge}
                </li>
            `;
        });

        sectionsHTML += '</ul>';
        sectionsList.innerHTML = sectionsHTML;
    }

    // Nascondi spinner e mostra contenuto
    document.getElementById('loading-spinner').style.display = 'none';
    document.getElementById('dashboard-content').style.display = 'flex';
}

function showError(message) {
    document.getElementById('loading-spinner').style.display = 'none';
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-container').style.display = 'block';
}

// Carica al DOMContentLoaded
document.addEventListener('DOMContentLoaded', loadAdminSections);
</script>

<%- include( passData.themeSys.getThemePartPath( 'footer.ejs', passData ) ) %>
