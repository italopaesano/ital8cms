<!-- TEMPLTE PER LA CREAZIONE DELLEE PAGINE DI AMMINISTRAZIONE  -->
<!-- ATTENZIONE  nelle pagine di admin sarà chiamata la funzone getAdminThemePartPath() e non la funzione getThemePartPath() -->
<%- include( passData.themeSys.getAdminThemePartPath( 'head.ejs' ) ) %>
<%- include( passData.themeSys.getAdminThemePartPath( 'header.ejs' ) ) %>

<!-- api prefix -->
<span id="apiPrefix" style="display: none;"><%- passData.apiPrefix %></span>
<script>
    const apiPrefix = document.getElementById('apiPrefix').innerText;
</script>

<!-- adminPrefix -->
<span id="adminPrefix" style="display: none;"><%- passData.adminPrefix %></span>
<script>
    const adminPrefix = document.getElementById('adminPrefix').innerText;
</script>

<h1>Gestione degli utenti </h1>

<div class="container mt-4">
    <h2>Lista Utenti</h2>
    <div id="userList" class="list-group">
        <!-- User list will be populated here -->
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async function () {
        const userList = document.getElementById('userList');

        try {
            // Fetch user list
            const userResponse = await fetch(`/${apiPrefix}/simpleAccess/userList`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!userResponse.ok) {
                throw new Error(`HTTP error! status: ${userResponse.status}`);
            }

            const users = await userResponse.json();

            // Fetch role list
            const roleResponse = await fetch(`/${apiPrefix}/simpleAccess/roleList`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (!roleResponse.ok) {
                throw new Error(`HTTP error! status: ${roleResponse.status}`);
            }

            const rolesData = await roleResponse.json();
            const roles = rolesData.roles;

            if (Array.isArray(users) && users.length > 0) {
                users.forEach(user => {
                    const userItem = document.createElement('a');
                    userItem.href = "#";
                    userItem.className = "list-group-item list-group-item-action";

                    const roleName = roles[user.roleId] ? roles[user.roleId].name : 'Ruolo sconosciuto';

                    userItem.innerHTML = `
                        <strong>Username:</strong> ${user.username} <br>
                        <strong>Role:</strong> ${roleName}
                    `;
                    userList.appendChild(userItem);
                });
            } else {
                userList.innerHTML = '<p class="text-danger">Nessun utente trovato.</p>';
            }
        } catch (error) {
            console.error('Errore:', error);
            userList.innerHTML = '<p class="text-danger">Errore nel recupero della lista utenti o ruoli.</p>';
        }
    });
</script>

<div class="container mt-4">
    <button id="createUserBtn" class="btn btn-primary">
        <i class="bi bi-plus"></i> Crea Utente
    </button>

    <form id="createUserForm" class="mt-3" style="display: none;">
        <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" placeholder="Inserisci username" required>
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" placeholder="Inserisci email" required>
        </div>
        <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password" placeholder="Inserisci password" required>
        </div>
        <button type="submit" class="btn btn-success">Salva</button>
    </form>
</div>

<script>
    document.getElementById('createUserBtn').addEventListener('click', function () {//questo evento rende visibile il form
        const form = document.getElementById('createUserForm');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    });

    document.getElementById('createUserForm').addEventListener('submit', async function (event) {
        event.preventDefault();

        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch(`/${apiPrefix}/simpleAccess/createUser`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, email, password })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                const successMessage = document.createElement('div');
                successMessage.className = 'alert alert-success mt-3';
                successMessage.textContent = result.success; //qui conterrà il messaggio di successo
                document.getElementById('createUserForm').style.display = 'none';
                document.getElementById('createUserForm').after(successMessage);
            } else if (result.error) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'alert alert-danger mt-3';
                errorMessage.textContent = result.error; // Messaggio di errore
                document.getElementById('createUserForm').after(errorMessage);

                if (result.errorType === 'all') {
                    // Evidenzia tutti i campi
                    ['username', 'email', 'password'].forEach(field => {
                        const inputField = document.getElementById(field);
                        if (inputField) {
                            inputField.classList.add('is-invalid');
                        }
                    });
                } else {
                    // Evidenzia solo il campo specifico
                    const inputField = document.getElementById(result.errorType);
                    if (inputField) {
                        inputField.classList.add('is-invalid');
                    }
                }
            } else {
                throw new Error('Errore sconosciuto.');
            }
            alert('Utente creato con successo!');
            document.getElementById('createUserForm').reset();
            document.getElementById('createUserForm').style.display = 'none';
        } catch (error) {
            console.error('Errore:', error);
            alert('Errore nella creazione dell\'utente.');
        }
    });
</script>





<%- include( passData.themeSys.getAdminThemePartPath( 'footer.ejs' ) ) %>