<!-- GESTIONE TEMI - Lista e attivazione temi per sito pubblico e admin -->
<!-- ATTENZIONE nelle pagine di admin sarÃ  chiamata la funzione getAdminThemePartPath() e non la funzione getThemePartPath() -->
<%- include( passData.themeSys.getAdminThemePartPath( 'head.ejs' ) ) %>
<%- include( passData.themeSys.getAdminThemePartPath( 'header.ejs' ) ) %>

<!-- api prefix -->
<span id="apiPrefix" style="display: none;"><%- passData.apiPrefix %></span>
<script>
    const apiPrefix = document.getElementById('apiPrefix').innerText;
</script>

<!-- adminPrefix -->
<span id="adminPrefix" style="display: none;"><%- passData.adminPrefix %></span>
<script>
    const adminPrefix = document.getElementById('adminPrefix').innerText;
</script>

<%
// Leggo i temi disponibili dalla cartella themes
const fs = require('fs');
const path = require('path');

const themesPath = path.join(__dirname, '../../../../themes');
const themesList = [];

try {
    const themeDirs = fs.readdirSync(themesPath);

    themeDirs.forEach(themeName => {
        const themeDir = path.join(themesPath, themeName);
        const stat = fs.statSync(themeDir);

        if (stat.isDirectory()) {
            // Leggo themeConfig.json se esiste
            const configPath = path.join(themeDir, 'themeConfig.json');
            const readmePath = path.join(themeDir, 'README.md');

            let config = {};
            let readme = '';

            if (fs.existsSync(configPath)) {
                config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
            }

            if (fs.existsSync(readmePath)) {
                readme = fs.readFileSync(readmePath, 'utf8');
            }

            // Verifico struttura tema (deve avere views/)
            const viewsPath = path.join(themeDir, 'views');
            const hasViews = fs.existsSync(viewsPath);

            themesList.push({
                name: themeName,
                config: config,
                readme: readme,
                hasViews: hasViews,
                path: themeDir
            });
        }
    });
} catch (error) {
    console.error('Errore nel caricamento dei temi:', error);
}

// Leggo configurazione attuale
const ital8Conf = require('../../../../ital8Config.json');
const currentPublicTheme = ital8Conf.activeTheme;
const currentAdminTheme = ital8Conf.adminActiveTheme;
%>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-palette"></i> Gestione Temi</h2>
        <a href="/<%= passData.adminPrefix %>" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Torna alla Dashboard
        </a>
    </div>

    <!-- Configurazione Attuale -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-globe"></i> Tema Sito Pubblico
                </div>
                <div class="card-body">
                    <h5 class="card-title"><%= currentPublicTheme %></h5>
                    <p class="card-text text-muted">Tema attualmente attivo per le pagine pubbliche del sito.</p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-gear"></i> Tema Admin Panel
                </div>
                <div class="card-body">
                    <h5 class="card-title"><%= currentAdminTheme %></h5>
                    <p class="card-text text-muted">Tema attualmente attivo per il pannello di amministrazione.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista Temi Disponibili -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-collection"></i> Temi Disponibili (<%= themesList.length %>)</h5>
        </div>
        <div class="card-body">
            <% if (themesList.length === 0) { %>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> Nessun tema trovato nella cartella themes/
                </div>
            <% } else { %>
                <div class="row">
                    <% themesList.forEach(theme => { %>
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100 <%= theme.name === currentPublicTheme ? 'border-primary' : '' %> <%= theme.name === currentAdminTheme ? 'border-success' : '' %>">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <strong><%= theme.name %></strong>
                                    <span>
                                        <% if (theme.name === currentPublicTheme) { %>
                                            <span class="badge bg-primary" title="Tema pubblico attivo">
                                                <i class="bi bi-globe"></i>
                                            </span>
                                        <% } %>
                                        <% if (theme.name === currentAdminTheme) { %>
                                            <span class="badge bg-success" title="Tema admin attivo">
                                                <i class="bi bi-gear"></i>
                                            </span>
                                        <% } %>
                                    </span>
                                </div>
                                <div class="card-body">
                                    <!-- Info Tema -->
                                    <ul class="list-unstyled small">
                                        <li>
                                            <% if (theme.hasViews) { %>
                                                <i class="bi bi-check-circle text-success"></i>
                                            <% } else { %>
                                                <i class="bi bi-x-circle text-danger"></i>
                                            <% } %>
                                            Cartella views/
                                        </li>
                                        <li>
                                            <% if (theme.config.isInstalled) { %>
                                                <i class="bi bi-check-circle text-success"></i>
                                            <% } else { %>
                                                <i class="bi bi-x-circle text-danger"></i>
                                            <% } %>
                                            Installato
                                        </li>
                                        <li>
                                            <i class="bi bi-sort-numeric-down"></i>
                                            Weight: <%= theme.config.weight || 0 %>
                                        </li>
                                    </ul>

                                    <% if (theme.readme) { %>
                                        <p class="card-text small text-muted">
                                            <%= theme.readme.substring(0, 100) %><%= theme.readme.length > 100 ? '...' : '' %>
                                        </p>
                                    <% } %>
                                </div>
                                <div class="card-footer">
                                    <div class="btn-group btn-group-sm w-100" role="group">
                                        <a href="/<%= passData.adminPrefix %>/themeManagment/themeView.ejs?theme=<%= theme.name %>"
                                           class="btn btn-outline-info" title="Visualizza dettagli">
                                            <i class="bi bi-eye"></i> Dettagli
                                        </a>
                                        <% if (theme.name !== currentPublicTheme) { %>
                                            <button type="button"
                                                    class="btn btn-outline-primary"
                                                    onclick="activateTheme('<%= theme.name %>', 'public')"
                                                    title="Imposta come tema pubblico">
                                                <i class="bi bi-globe"></i>
                                            </button>
                                        <% } %>
                                        <% if (theme.name !== currentAdminTheme) { %>
                                            <button type="button"
                                                    class="btn btn-outline-success"
                                                    onclick="activateTheme('<%= theme.name %>', 'admin')"
                                                    title="Imposta come tema admin">
                                                <i class="bi bi-gear"></i>
                                            </button>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Legenda -->
    <div class="mt-3">
        <small class="text-muted">
            <span class="badge bg-primary"><i class="bi bi-globe"></i></span> Tema pubblico attivo |
            <span class="badge bg-success"><i class="bi bi-gear"></i></span> Tema admin attivo
        </small>
    </div>
</div>

<!-- Modal Conferma Attivazione -->
<div class="modal fade" id="activateThemeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Conferma Attivazione Tema</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="activateThemeMessage"></p>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Nota:</strong> Per applicare il nuovo tema, potrebbe essere necessario riavviare il server.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <button type="button" class="btn btn-primary" id="confirmActivateBtn">
                    <i class="bi bi-check"></i> Conferma
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let pendingTheme = null;
let pendingType = null;

function activateTheme(themeName, themeType) {
    pendingTheme = themeName;
    pendingType = themeType;

    const typeLabel = themeType === 'public' ? 'sito pubblico' : 'pannello admin';
    const message = `Vuoi attivare il tema "<strong>${themeName}</strong>" per il ${typeLabel}?`;

    document.getElementById('activateThemeMessage').innerHTML = message;

    const modal = new bootstrap.Modal(document.getElementById('activateThemeModal'));
    modal.show();
}

document.getElementById('confirmActivateBtn').addEventListener('click', async function() {
    if (!pendingTheme || !pendingType) return;

    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Attivazione...';

    try {
        const response = await fetch(`/${apiPrefix}/admin/setTheme`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                themeName: pendingTheme,
                themeType: pendingType
            })
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message || 'Tema attivato con successo!');
            // Ricarica la pagina per vedere le modifiche
            window.location.reload();
        } else {
            alert('Errore: ' + (result.error || 'Impossibile attivare il tema'));
        }
    } catch (error) {
        console.error('Errore:', error);
        alert('Errore nella richiesta: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-check"></i> Conferma';
        bootstrap.Modal.getInstance(document.getElementById('activateThemeModal')).hide();
    }
});
</script>

<%- include( passData.themeSys.getAdminThemePartPath( 'footer.ejs' ) ) %>
