<!-- TEMPLATE PER LA CREAZIONE/MODIFICA UTENTI -->
<!-- NOTA: Usa getThemePartPath() con passData (che contiene isAdminContext: true) -->
<!--       per caricare automaticamente i partial del tema admin -->
<%- include( passData.themeSys.getThemePartPath( 'head.ejs', passData ) ) %>
<%- include( passData.themeSys.getThemePartPath( 'header.ejs', passData ) ) %>

<!-- api prefix -->
<span id="apiPrefix" style="display: none;"><%- passData.apiPrefix %></span>
<script>
    const apiPrefix = document.getElementById('apiPrefix').innerText;
</script>

<!-- adminPrefix -->
<span id="adminPrefix" style="display: none;"><%- passData.adminPrefix %></span>
<script>
    const adminPrefix = document.getElementById('adminPrefix').innerText;
</script>

<!-- se la query string contiene un valore valido di username allora si tratta di un aggiornamento altrimenti di un nuovo utente -->
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const isNewUser = !urlParams.has('username') || !urlParams.get('username').trim();

    document.addEventListener('DOMContentLoaded', () => {
        const usernameField = document.getElementById('username');
        const pageTitle = document.getElementById('pageTitle');

        if (isNewUser) {
            usernameField.disabled = false;
            pageTitle.textContent = 'Crea Nuovo Utente';
        } else {
            usernameField.disabled = true;
            usernameField.value = urlParams.get('username') || '';
            pageTitle.textContent = 'Modifica Utente';
        }
    });
</script>

<div class="container mt-4">
    <div class="text-center mb-4">
        <h1 id="pageTitle">Gestione Utente</h1>
    </div>

    <form id="createUserForm" class="mt-3">
        <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input type="text" class="form-control" id="username" placeholder="Inserisci username" required>
        </div>
        <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" placeholder="Inserisci email" required>
        </div>
        <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password" placeholder="Inserisci password" required>
        </div>

        <!-- SEZIONE RUOLI CON CHECKBOX MULTIPLI -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üîê Assegnazione Ruoli</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Seleziona uno o pi√π ruoli per questo utente. I permessi saranno la combinazione di tutti i ruoli selezionati.
                </p>

                <!-- Ruoli Hardcoded -->
                <h6 class="mb-2">Ruoli di Sistema:</h6>
                <div id="hardcodedRoles" class="mb-3">
                    <!-- Popolato dinamicamente -->
                </div>

                <hr>

                <!-- Ruoli Custom -->
                <h6 class="mb-2">Ruoli Personalizzati:</h6>
                <div id="customRoles">
                    <!-- Popolato dinamicamente -->
                </div>
                <div id="noCustomRoles" class="text-muted" style="display: none;">
                    üí° Nessun ruolo custom disponibile.
                    <a href="/<%= passData.adminPrefix %>/rolesManagment/index.ejs">Creane uno!</a>
                </div>

                <!-- Ruoli selezionati (summary) -->
                <div class="mt-3">
                    <small class="text-muted">Ruoli selezionati: <span id="selectedRolesSummary" class="fw-bold">Nessuno</span></small>
                </div>
            </div>
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-success">üíæ Salva Utente</button>
            <a href="/<%= passData.adminPrefix %>/usersManagment/index.ejs" class="btn btn-secondary">‚ùå Annulla</a>
        </div>
    </form>
</div>

<script>
    let allRoles = {};  // Mappa ID ‚Üí role object

    // Carica ruoli hardcoded
    async function loadHardcodedRoles() {
        try {
            const response = await fetch(`/${apiPrefix}/adminUsers/hardcodedRoleList`);
            const roles = await response.json();

            const container = document.getElementById('hardcodedRoles');
            container.innerHTML = '';

            roles.forEach(role => {
                allRoles[role.id] = role;

                const checkbox = document.createElement('div');
                checkbox.className = 'form-check mb-2';

                // ROOT (ID 0) sempre disabilitato - nessuno pu√≤ assegnarlo/revocarlo
                const isRoot = role.id === 0;
                const disabled = isRoot ? 'disabled' : '';
                const title = isRoot ? 'Il ruolo root pu√≤ essere assegnato solo tramite script di inizializzazione' : '';

                checkbox.innerHTML = `
                    <input class="form-check-input role-checkbox"
                           type="checkbox"
                           value="${role.id}"
                           id="role_${role.id}"
                           ${disabled}
                           onchange="updateSelectedSummary()">
                    <label class="form-check-label" for="role_${role.id}" title="${title}">
                        ${isRoot ? 'üî¥' : role.id === 1 ? 'üëë' : role.id === 2 ? '‚úèÔ∏è' : 'üìù'}
                        <strong>${role.name}</strong> (ID: ${role.id})
                        <br>
                        <small class="text-muted">${role.description}</small>
                        ${isRoot ? '<br><small class="text-danger">‚õî Disabilitato - Solo via script init</small>' : ''}
                    </label>
                `;
                container.appendChild(checkbox);
            });
        } catch (error) {
            console.error('Errore caricamento ruoli hardcoded:', error);
        }
    }

    // Carica ruoli custom
    async function loadCustomRoles() {
        try {
            const response = await fetch(`/${apiPrefix}/adminUsers/customRoleList`);
            const roles = await response.json();

            const container = document.getElementById('customRoles');
            const noRolesDiv = document.getElementById('noCustomRoles');

            if (roles.length === 0) {
                container.style.display = 'none';
                noRolesDiv.style.display = 'block';
                return;
            }

            container.innerHTML = '';
            noRolesDiv.style.display = 'none';

            roles.forEach(role => {
                allRoles[role.id] = role;

                const checkbox = document.createElement('div');
                checkbox.className = 'form-check mb-2';
                checkbox.innerHTML = `
                    <input class="form-check-input role-checkbox"
                           type="checkbox"
                           value="${role.id}"
                           id="role_${role.id}"
                           onchange="updateSelectedSummary()">
                    <label class="form-check-label" for="role_${role.id}">
                        üõ°Ô∏è <strong>${role.name}</strong> (ID: ${role.id})
                        <br>
                        <small class="text-muted">${role.description}</small>
                    </label>
                `;
                container.appendChild(checkbox);
            });
        } catch (error) {
            console.error('Errore caricamento ruoli custom:', error);
        }
    }

    // Aggiorna il summary dei ruoli selezionati
    function updateSelectedSummary() {
        const checkboxes = document.querySelectorAll('.role-checkbox:checked');
        const selectedNames = Array.from(checkboxes).map(cb => allRoles[cb.value].name);

        const summary = document.getElementById('selectedRolesSummary');
        if (selectedNames.length === 0) {
            summary.textContent = 'Nessuno';
            summary.className = 'fw-bold text-danger';
        } else {
            summary.textContent = selectedNames.join(', ');
            summary.className = 'fw-bold text-success';
        }
    }

    // Carica ruoli al caricamento pagina
    document.addEventListener('DOMContentLoaded', async () => {
        await loadHardcodedRoles();
        await loadCustomRoles();

        // Se stiamo modificando un utente, carica i suoi ruoli
        if (!isNewUser) {
            const username = urlParams.get('username');
            await loadUserData(username);
        }
    });

    // Carica dati utente esistente (per modifica)
    async function loadUserData(username) {
        try {
            const response = await fetch(`/${apiPrefix}/adminUsers/userInfo?username=${encodeURIComponent(username)}`);
            const userInfo = await response.json();

            // Popola i campi
            document.getElementById('email').value = userInfo.email || '';
            document.getElementById('password').value = '';  // Non mostrare password

            // Seleziona i ruoli dell'utente
            if (userInfo.roleIds && Array.isArray(userInfo.roleIds)) {
                userInfo.roleIds.forEach(roleId => {
                    const checkbox = document.getElementById(`role_${roleId}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                updateSelectedSummary();
            }
        } catch (error) {
            console.error('Errore caricamento dati utente:', error);
        }
    }

    // Gestione submit form
    document.getElementById('createUserForm').addEventListener('submit', async function (event) {
        event.preventDefault();

        const username = isNewUser ? document.getElementById('username').value : urlParams.get('username');
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        // Raccogli tutti i ruoli selezionati come array di numeri
        const checkboxes = document.querySelectorAll('.role-checkbox:checked');
        const roleIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

        // Validazione: almeno un ruolo deve essere selezionato
        if (roleIds.length === 0) {
            alert('Errore: Devi selezionare almeno un ruolo per l\'utente.');
            return;
        }

        try {
            const response = await fetch(`/${apiPrefix}/adminUsers/usertUser`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, email, password, roleIds, isNewUser })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                alert(result.success);
                // Pulisci eventuali messaggi di errore precedenti
                const existingErrorMessage = document.getElementById('errorMessage');
                if (existingErrorMessage) {
                    existingErrorMessage.remove();
                }
                // Reindirizza alla lista utenti
                window.location.href = `/${adminPrefix}/usersManagment/index.ejs`;
            } else if (result.error) {
                // Mostra messaggio di errore
                let errorMessage = document.getElementById('errorMessage');
                if (!errorMessage) {
                    errorMessage = document.createElement('div');
                    errorMessage.id = 'errorMessage';
                    errorMessage.className = 'alert alert-danger mt-3';
                    document.getElementById('createUserForm').after(errorMessage);
                }
                errorMessage.textContent = result.error;

                // Evidenzia campi con errore
                document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

                if (result.errorType === 'all') {
                    ['username', 'email', 'password'].forEach(field => {
                        const inputField = document.getElementById(field);
                        if (inputField) {
                            inputField.classList.add('is-invalid');
                        }
                    });
                } else if (result.errorType) {
                    const inputField = document.getElementById(result.errorType);
                    if (inputField) {
                        inputField.classList.add('is-invalid');
                    }
                }
            } else {
                throw new Error('Errore sconosciuto.');
            }
        } catch (error) {
            console.error('Errore:', error);
            alert('Errore nella gestione dell\'utente: ' + error.message);
        }
    });
</script>

<%- include( passData.themeSys.getThemePartPath( 'footer.ejs', passData ) ) %>
