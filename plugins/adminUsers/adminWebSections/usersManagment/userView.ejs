<!-- TEMPLATE PER LA CREAZIONE DELLE PAGINE DI AMMINISTRAZIONE  -->
<!-- NOTA: Usa getThemePartPath() con passData (che contiene isAdminContext: true) -->
<!--       per caricare automaticamente i partial del tema admin -->
<%- include( passData.themeSys.getThemePartPath( 'head.ejs', passData ) ) %>
<%- include( passData.themeSys.getThemePartPath( 'header.ejs', passData ) ) %>

<!-- api prefix -->
<span id="apiPrefix" style="display: none;"><%- passData.apiPrefix %></span>
<script>
    const apiPrefix = document.getElementById('apiPrefix').innerText;
</script>

<!-- adminPrefix -->
<span id="adminPrefix" style="display: none;"><%- passData.adminPrefix %></span>
<script>
    const adminPrefix = document.getElementById('adminPrefix').innerText;
</script>

<h1>visualizza le informazioni di un utente</h1>

<div class="container mt-5 user-management admin-section">
    <div id="user-info-container" class="card user-info-card"></div>
        <div class="card-header user-info-header">
            <h2>Informazioni Utente</h2>
        </div>
        <div class="card-body user-info-body">
            <div class="mb-3 user-info-item">
                <label for="username" class="form-label"><strong>Nome Utente:</strong></label>
                <p id="username" class="user-info-value">Utente non trovato</p>
            </div>
            <div class="mb-3 user-info-item">
                <label for="email" class="form-label"><strong>Email:</strong></label>
                <p id="email" class="user-info-value">N/A</p>
            </div>
            <div class="mb-3 user-info-item">
                <label for="roles" class="form-label"><strong>Ruoli:</strong></label>
                <div id="roles" class="user-info-value">Nessun ruolo assegnato</div>
            </div>
        </div>
        <div class="card-footer text-center user-info-footer">
            <a href="/<%- passData.adminPrefix %>/usersManagment/index.ejs" class="btn btn-primary me-2 user-action-btn">Torna alla Index</a>
            <a href="#" id="edit-user-btn" class="btn btn-warning me-2 user-action-btn" >Modifica Dati</a> <!-- l' href di questolink verr√† aggiornato da uno script pi√π in basso -->
            <a href="#" id="delete-user-btn" class="btn btn-danger user-action-btn" >Elimina Utente</a> <!-- l' href di questolink verr√† aggiornato da uno script pi√π in basso -->
        </div>
    </div>
    <div id="error-message" class="alert alert-warning" style="display: none;">
        Non √® stato indicato l'utente di cui caricare le informazioni.
    </div>
</div>

<script>
    const queryParams = new URLSearchParams(window.location.search);
    const username = queryParams.get('username');

    if (!username) {
        document.getElementById('error-message').style.display = 'block';
    } else {
        fetch(`/${apiPrefix}/adminUsers/userInfo?username=${username}`)
            .then(response => response.json())
            .then(userInfo => {
                // Controllo aggiornato per sistema multi-role
                if (userInfo && userInfo.roleIds && Array.isArray(userInfo.roleIds)) {
                    document.getElementById('username').innerText = username || 'N/A';
                    document.getElementById('email').innerText = userInfo.email || 'N/A';

                    // Carica lista ruoli e mostra tutti i ruoli dell'utente
                    fetch(`/${apiPrefix}/adminUsers/roleList`)
                        .then(response => response.json())
                        .then(roleList => {
                            const allRoles = roleList.roles;
                            const rolesContainer = document.getElementById('roles');

                            if (userInfo.roleIds.length === 0) {
                                rolesContainer.innerHTML = '<span class="text-muted">Nessun ruolo assegnato</span>';
                            } else {
                                // Crea lista di badge per ogni ruolo
                                const rolesBadges = userInfo.roleIds.map(roleId => {
                                    const role = allRoles && allRoles[roleId];
                                    if (role) {
                                        // Icona diversa per ruoli hardcoded vs custom
                                        const icon = role.isHardcoded ?
                                            (roleId === 0 ? 'üî¥' : roleId === 1 ? 'üëë' : roleId === 2 ? '‚úèÔ∏è' : 'üìù') :
                                            'üõ°Ô∏è';
                                        const badgeClass = role.isHardcoded ? 'bg-primary' : 'bg-success';
                                        return `
                                            <span class="badge ${badgeClass} me-2 mb-2" style="font-size: 0.9rem;" title="${role.description || 'Nessuna descrizione'}">
                                                ${icon} ${role.name} (ID: ${roleId})
                                            </span>
                                        `;
                                    } else {
                                        return `<span class="badge bg-danger me-2 mb-2">‚ö†Ô∏è Ruolo ${roleId} non trovato</span>`;
                                    }
                                }).join('');

                                rolesContainer.innerHTML = rolesBadges;
                            }
                        })
                        .catch(() => {
                            document.getElementById('roles').innerHTML = '<span class="text-danger">Errore nel caricamento dei ruoli</span>';
                        });

                    document.getElementById('edit-user-btn').href = `/${adminPrefix}/usersManagment/userUpsert.ejs?username=${username}`;
                    document.getElementById('delete-user-btn').href = `/${adminPrefix}/usersManagment/userDelete.ejs?username=${username}`;
                    document.getElementById('user-info-container').style.display = 'block';
                } else {
                    document.getElementById('error-message').innerText = 'Utente non trovato o dati non validi.';
                    document.getElementById('error-message').style.display = 'block';
                }
            })
            .catch(() => {
                document.getElementById('error-message').innerText = 'Errore nel caricamento delle informazioni utente.';
                document.getElementById('error-message').style.display = 'block';
            });
    }
</script>


<%- include( passData.themeSys.getThemePartPath( 'footer.ejs', passData ) ) %>