<!-- TEMPLATE PER LA MODIFICA DEL PROFILO UTENTE (username e password) -->
<!-- Permette all'utente loggato di modificare i propri dati -->
<!-- NOTA: Usa getThemePartPath() con passData per caricare i partial del tema corretto -->
<%- include( passData.themeSys.getThemePartPath( 'head.ejs', passData ) ) %>
<%- include( passData.themeSys.getThemePartPath( 'header.ejs', passData ) ) %>

<!-- api prefix -->
<span id="apiPrefix" style="display: none;"><%- passData.apiPrefix %></span>
<script>
    const apiPrefix = document.getElementById('apiPrefix').innerText;
</script>

<div class="container mt-4">
    <div class="text-center mb-4">
        <h1>üîê Modifica Profilo Utente</h1>
        <p class="text-muted">Aggiorna il tuo username e la tua password</p>
    </div>

    <!-- Alert messaggi -->
    <div id="alertContainer"></div>

    <!-- Form modifica profilo -->
    <form id="userProfileForm" class="mt-3">
        <!-- Username da cercare (per testing senza autenticazione) -->
        <div class="card mb-3 border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">‚öôÔ∏è Testing (senza autenticazione)</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="testUsername" class="form-label">Username da modificare</label>
                    <input type="text" class="form-control" id="testUsername" value="testuser" placeholder="Inserisci username">
                    <small class="form-text text-muted">Inserisci lo username dell'utente da modificare (es: testuser)</small>
                </div>
                <button type="button" class="btn btn-warning" onclick="loadCurrentUserData()">üîÑ Carica Dati Utente</button>
            </div>
        </div>

        <!-- Informazioni utente corrente -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">üë§ Informazioni Attuali</h5>
            </div>
            <div class="card-body">
                <p><strong>Username attuale:</strong> <span id="currentUsername">-</span></p>
                <p><strong>Email:</strong> <span id="currentEmail">-</span></p>
                <p class="text-muted mb-0">
                    <small>üí° Per motivi di sicurezza, dovrai inserire la tua password attuale per confermare le modifiche.</small>
                </p>
            </div>
        </div>

        <!-- Sezione modifica username -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">üìù Modifica Username</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="newUsername" class="form-label">Nuovo Username</label>
                    <input type="text" class="form-control" id="newUsername" placeholder="Inserisci nuovo username (lascia vuoto per mantenere attuale)">
                    <small class="form-text text-muted">Minimo 3 caratteri, solo lettere, numeri, underscore e trattini</small>
                </div>
            </div>
        </div>

        <!-- Sezione modifica password -->
        <div class="card mb-3">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">üîë Modifica Password</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="newPassword" class="form-label">Nuova Password</label>
                    <input type="password" class="form-control" id="newPassword" placeholder="Inserisci nuova password (lascia vuoto per mantenere attuale)">
                    <small class="form-text text-muted">Minimo 8 caratteri raccomandati</small>
                </div>
                <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Conferma Nuova Password</label>
                    <input type="password" class="form-control" id="confirmPassword" placeholder="Reinserisci la nuova password">
                </div>
            </div>
        </div>

        <!-- Password attuale (richiesta per confermare modifiche) -->
        <div class="card mb-3">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">üîí Conferma Identit√†</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="currentPassword" class="form-label">Password Attuale <span class="text-danger">*</span></label>
                    <input type="password" class="form-control" id="currentPassword" placeholder="Inserisci la tua password attuale" required>
                    <small class="form-text text-danger">Obbligatorio per confermare le modifiche</small>
                </div>
            </div>
        </div>

        <!-- Pulsanti azione -->
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-success">üíæ Salva Modifiche</button>
            <button type="button" class="btn btn-secondary" onclick="window.history.back()">‚ùå Annulla</button>
        </div>
    </form>
</div>

<script>
    let currentUserData = {};

    // Carica dati utente corrente
    async function loadCurrentUserData() {
        try {
            const username = document.getElementById('testUsername').value;
            if (!username) {
                showAlert('‚ö†Ô∏è Inserisci uno username valido', 'warning');
                return;
            }

            const response = await fetch(`/${apiPrefix}/adminUsers/getCurrentUser?username=${encodeURIComponent(username)}`);
            if (!response.ok) {
                throw new Error('Errore caricamento dati utente');
            }

            currentUserData = await response.json();

            // Popola i campi informativi
            document.getElementById('currentUsername').textContent = currentUserData.username || 'N/A';
            document.getElementById('currentEmail').textContent = currentUserData.email || 'N/A';

            showAlert('‚úÖ Dati utente caricati con successo', 'success');

        } catch (error) {
            console.error('Errore caricamento dati utente:', error);
            showAlert('‚ùå Errore nel caricamento dei dati utente: ' + error.message, 'danger');
        }
    }

    // Mostra alert messaggi
    function showAlert(message, type = 'info') {
        const alertContainer = document.getElementById('alertContainer');
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.innerHTML = '';
        alertContainer.appendChild(alertDiv);

        // Scroll alla vista
        alertContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Auto-dismiss dopo 5 secondi
        if (type === 'success') {
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    }

    // Validazione form
    function validateForm() {
        const newUsername = document.getElementById('newUsername').value.trim();
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const currentPassword = document.getElementById('currentPassword').value;

        // Verifica che almeno un campo sia compilato
        if (!newUsername && !newPassword) {
            showAlert('‚ö†Ô∏è Devi modificare almeno il username o la password.', 'warning');
            return false;
        }

        // Verifica password attuale obbligatoria
        if (!currentPassword) {
            showAlert('‚ö†Ô∏è La password attuale √® obbligatoria per confermare le modifiche.', 'warning');
            document.getElementById('currentPassword').focus();
            return false;
        }

        // Validazione username (se modificato)
        if (newUsername) {
            if (newUsername.length < 3) {
                showAlert('‚ö†Ô∏è Il nuovo username deve contenere almeno 3 caratteri.', 'warning');
                document.getElementById('newUsername').focus();
                return false;
            }
            if (!/^[a-zA-Z0-9_-]+$/.test(newUsername)) {
                showAlert('‚ö†Ô∏è Il nuovo username pu√≤ contenere solo lettere, numeri, underscore (_) e trattini (-).', 'warning');
                document.getElementById('newUsername').focus();
                return false;
            }
        }

        // Validazione password (se modificata)
        if (newPassword) {
            if (newPassword.length < 6) {
                showAlert('‚ö†Ô∏è La nuova password deve contenere almeno 6 caratteri (8 raccomandati).', 'warning');
                document.getElementById('newPassword').focus();
                return false;
            }
            if (newPassword !== confirmPassword) {
                showAlert('‚ö†Ô∏è Le password non coincidono. Controlla e riprova.', 'warning');
                document.getElementById('confirmPassword').focus();
                return false;
            }
        }

        return true;
    }

    // Gestione submit form
    document.getElementById('userProfileForm').addEventListener('submit', async function (event) {
        event.preventDefault();

        // Validazione
        if (!validateForm()) {
            return;
        }

        const currentUsername = document.getElementById('testUsername').value;
        if (!currentUsername) {
            showAlert('‚ö†Ô∏è Devi prima caricare i dati di un utente', 'warning');
            return;
        }

        const newUsername = document.getElementById('newUsername').value.trim() || null;
        const newPassword = document.getElementById('newPassword').value || null;
        const currentPassword = document.getElementById('currentPassword').value;

        try {
            const response = await fetch(`/${apiPrefix}/adminUsers/updateUserProfile`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    currentUsername,
                    newUsername,
                    newPassword,
                    currentPassword
                })
            });

            const result = await response.json();

            if (response.ok && result.success) {
                showAlert(`‚úÖ ${result.success}`, 'success');

                // Se username √® cambiato, aggiorna il campo testUsername
                if (newUsername) {
                    document.getElementById('testUsername').value = newUsername;
                    showAlert('‚ö†Ô∏è Username modificato! Aggiorna il campo "Username da modificare" se necessario.', 'info');
                }

                // Reset solo i campi di modifica (non il testUsername)
                document.getElementById('newUsername').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                document.getElementById('currentPassword').value = '';

                // Ricarica dati utente
                setTimeout(() => {
                    loadCurrentUserData();
                }, 1000);
            } else if (result.error) {
                showAlert(`‚ùå ${result.error}`, 'danger');

                // Evidenzia campo con errore se specificato
                if (result.errorField) {
                    const field = document.getElementById(result.errorField);
                    if (field) {
                        field.classList.add('is-invalid');
                        field.focus();
                        setTimeout(() => field.classList.remove('is-invalid'), 3000);
                    }
                }
            } else {
                throw new Error('Risposta del server non valida');
            }
        } catch (error) {
            console.error('Errore:', error);
            showAlert(`‚ùå Errore nella modifica del profilo: ${error.message}`, 'danger');
        }
    });

    // Non caricare automaticamente - l'utente deve cliccare il pulsante "Carica Dati Utente"
</script>

<%- include( passData.themeSys.getThemePartPath( 'footer.ejs', passData ) ) %>
