<!--
  Plugin: adminUsers
  Page: userProfile
  Template standard: Plugin Pages System
  Customization: themes/{themeName}/pluginsEndpointsMarkup/adminUsers/userProfile/

  PROFILO UTENTE - Solo utenti autenticati
  Tab "Profilo": visualizzazione dati (username, email mascherata, ruoli con descrizione)
  Tab "Modifica Credenziali": 3 sezioni indipendenti (username, email, password)
-->
<!DOCTYPE html>
<html lang="it">

<!-- Include theme head partial (contains Bootstrap, meta tags, etc.) -->
<%- include(passData.themeSys.getThemePartPath('head.ejs')) %>

<!-- Inject theme custom CSS for this specific plugin page -->
<%- passData.themeSys.injectPluginCss() %>

<!-- Inject theme custom JS for this specific plugin page -->
<%- passData.themeSys.injectPluginJs() %>

<title>Profilo Utente - ital8cms</title>
</head>

<body class="plugin-page plugin-adminUsers page-userProfile">

<!-- Include theme header partial (navigation, branding, etc.) -->
<%- include(passData.themeSys.getThemePartPath('header.ejs')) %>

<!-- Inject custom HTML BEFORE main content (from theme) -->
<%- passData.themeSys.injectPluginHtmlBefore() %>

<%
// Redirect server-side se non autenticato
if (!passData.ctx.session || !passData.ctx.session.authenticated || !passData.ctx.session.user) {
  // Il redirect viene gestito dalla regola accessControl, ma come fallback:
  // non renderizziamo il contenuto protetto
}
const isAuthenticated = passData.ctx.session && passData.ctx.session.authenticated && passData.ctx.session.user;
const sessionUsername = isAuthenticated ? passData.ctx.session.user.username : null;
%>

<% if (!isAuthenticated) { %>
<!-- Fallback: se l'utente non è autenticato mostra un messaggio -->
<main class="container mt-5">
  <div class="card border-warning">
    <div class="card-body text-center">
      <h5 class="card-title">Accesso richiesto</h5>
      <p class="card-text">Devi effettuare il login per accedere al tuo profilo.</p>
      <a href="/<%= passData.pluginPagesPrefix %>/adminUsers/login.ejs" class="btn btn-primary">Vai al Login</a>
    </div>
  </div>
</main>
<% } else { %>

<!-- Dati sessione per JavaScript -->
<script id="sessionData" type="application/json">
<%- JSON.stringify({ username: sessionUsername }) %>
</script>

<main class="container mt-4 mb-5">

  <!-- Navigazione superiore -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Profilo Utente</h2>
    <div class="d-flex gap-2">
      <a href="/" class="btn btn-outline-secondary btn-sm">Home</a>
      <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.history.back()">Indietro</button>
    </div>
  </div>

  <!-- Alert messaggi -->
  <div id="alertContainer"></div>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="profileTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-profilo" data-bs-toggle="tab" data-bs-target="#panel-profilo" type="button" role="tab" aria-controls="panel-profilo" aria-selected="true">Profilo</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-modifica" data-bs-toggle="tab" data-bs-target="#panel-modifica" type="button" role="tab" aria-controls="panel-modifica" aria-selected="false">Modifica Credenziali</button>
    </li>
  </ul>

  <div class="tab-content border border-top-0 rounded-bottom p-4" id="profileTabContent">

    <!-- ========== TAB PROFILO ========== -->
    <div class="tab-pane fade show active" id="panel-profilo" role="tabpanel" aria-labelledby="tab-profilo">

      <!-- Username -->
      <div class="mb-3">
        <label class="form-label fw-bold">Username</label>
        <p class="form-control-plaintext" id="profileUsername">Caricamento...</p>
      </div>

      <!-- Email (mascherata) -->
      <div class="mb-3">
        <label class="form-label fw-bold">Email</label>
        <div class="d-flex align-items-center gap-2">
          <span id="profileEmailMasked">Caricamento...</span>
          <span id="profileEmailFull" style="display:none;"></span>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="btnToggleEmail" onclick="toggleEmailVisibility()" style="display:none;">Mostra</button>
        </div>
      </div>

      <!-- Ruoli -->
      <div class="mb-3">
        <label class="form-label fw-bold">Ruoli assegnati</label>
        <div id="profileRoles">Caricamento...</div>
      </div>

    </div>

    <!-- ========== TAB MODIFICA CREDENZIALI ========== -->
    <div class="tab-pane fade" id="panel-modifica" role="tabpanel" aria-labelledby="tab-modifica">

      <!-- Sezione 1: Modifica Username -->
      <div class="card mb-4">
        <div class="card-header">
          <h6 class="mb-0">Modifica Username</h6>
        </div>
        <div class="card-body">
          <div class="alert alert-info" role="alert">
            Dopo la modifica dell'username verrai disconnesso e dovrai effettuare nuovamente il login con il nuovo username.
          </div>
          <form id="formUsername" novalidate>
            <div class="mb-3">
              <label for="newUsername" class="form-label">Nuovo Username</label>
              <input type="text" class="form-control" id="newUsername" placeholder="Minimo 3 caratteri, lettere, numeri, _ e -" minlength="3" pattern="^[a-zA-Z0-9_-]+$" required>
              <div class="form-text">Minimo 3 caratteri. Solo lettere, numeri, underscore (_) e trattini (-).</div>
            </div>
            <div class="mb-3">
              <label for="pwdForUsername" class="form-label">Password attuale <span class="text-danger">*</span></label>
              <input type="password" class="form-control" id="pwdForUsername" required>
            </div>
            <button type="submit" class="btn btn-primary">Salva Username</button>
          </form>
        </div>
      </div>

      <!-- Sezione 2: Modifica Email -->
      <div class="card mb-4">
        <div class="card-header">
          <h6 class="mb-0">Modifica Email</h6>
        </div>
        <div class="card-body">
          <form id="formEmail" novalidate>
            <div class="mb-3">
              <label for="newEmail" class="form-label">Nuova Email</label>
              <input type="email" class="form-control" id="newEmail" placeholder="esempio@dominio.com" required>
            </div>
            <div class="mb-3">
              <label for="pwdForEmail" class="form-label">Password attuale <span class="text-danger">*</span></label>
              <input type="password" class="form-control" id="pwdForEmail" required>
            </div>
            <button type="submit" class="btn btn-primary">Salva Email</button>
          </form>
        </div>
      </div>

      <!-- Sezione 3: Modifica Password -->
      <div class="card mb-4">
        <div class="card-header">
          <h6 class="mb-0">Modifica Password</h6>
        </div>
        <div class="card-body">
          <form id="formPassword" novalidate>
            <div class="mb-3">
              <label for="newPassword" class="form-label">Nuova Password</label>
              <input type="password" class="form-control" id="newPassword" placeholder="Minimo 6 caratteri (8 raccomandati)" minlength="6" required>
              <div class="form-text">Minimo 6 caratteri. Si raccomandano almeno 8 caratteri.</div>
            </div>
            <div class="mb-3">
              <label for="confirmPassword" class="form-label">Conferma Nuova Password</label>
              <input type="password" class="form-control" id="confirmPassword" required>
            </div>
            <div class="mb-3">
              <label for="pwdForPassword" class="form-label">Password attuale <span class="text-danger">*</span></label>
              <input type="password" class="form-control" id="pwdForPassword" required>
            </div>
            <button type="submit" class="btn btn-primary">Salva Password</button>
          </form>
        </div>
      </div>

    </div>
  </div>

  <!-- Navigazione inferiore -->
  <div class="d-flex justify-content-end gap-2 mt-3">
    <a href="/" class="btn btn-outline-secondary btn-sm">Home</a>
    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="window.history.back()">Indietro</button>
  </div>

</main>

<% } %>

<!-- Inject custom HTML AFTER main content (from theme) -->
<%- passData.themeSys.injectPluginHtmlAfter() %>

<!-- Include theme footer partial (scripts, closing tags) -->
<%- include(passData.themeSys.getThemePartPath('footer.ejs')) %>

<% if (isAuthenticated) { %>
<script>
  const apiPrefix = '<%= passData.apiPrefix %>';
  const loginUrl = '/<%= passData.pluginPagesPrefix %>/adminUsers/login.ejs';
  let currentUserData = {};
  let emailVisible = false;

  // --- Utility ---

  function showAlert(message, type) {
    const container = document.getElementById('alertContainer');
    container.innerHTML = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
      message +
      '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Chiudi"></button>' +
      '</div>';
    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    if (type === 'success') {
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }
  }

  function maskEmail(email) {
    if (!email) return '-';
    const parts = email.split('@');
    if (parts.length !== 2) return email;
    const local = parts[0];
    const domain = parts[1];
    const visibleChars = Math.min(2, local.length);
    return local.substring(0, visibleChars) + '***@' + domain;
  }

  function toggleEmailVisibility() {
    emailVisible = !emailVisible;
    const maskedEl = document.getElementById('profileEmailMasked');
    const fullEl = document.getElementById('profileEmailFull');
    const btn = document.getElementById('btnToggleEmail');
    if (emailVisible) {
      maskedEl.style.display = 'none';
      fullEl.style.display = '';
      btn.textContent = 'Nascondi';
    } else {
      maskedEl.style.display = '';
      fullEl.style.display = 'none';
      btn.textContent = 'Mostra';
    }
  }

  // --- Caricamento dati profilo ---

  async function loadProfile() {
    try {
      const response = await fetch('/' + apiPrefix + '/adminUsers/getCurrentUser');
      if (!response.ok) throw new Error('Errore nel caricamento del profilo');
      currentUserData = await response.json();

      // Username
      document.getElementById('profileUsername').textContent = currentUserData.username;

      // Email mascherata
      document.getElementById('profileEmailMasked').textContent = maskEmail(currentUserData.email);
      document.getElementById('profileEmailFull').textContent = currentUserData.email || '-';
      document.getElementById('btnToggleEmail').style.display = '';
      // Reset visibilità email
      emailVisible = false;
      document.getElementById('profileEmailMasked').style.display = '';
      document.getElementById('profileEmailFull').style.display = 'none';
      document.getElementById('btnToggleEmail').textContent = 'Mostra';

      // Ruoli
      const rolesContainer = document.getElementById('profileRoles');
      if (currentUserData.roles && currentUserData.roles.length > 0) {
        rolesContainer.innerHTML = currentUserData.roles.map(function(role) {
          return '<div class="d-flex align-items-start mb-2">' +
            '<span class="badge bg-secondary me-2 mt-1">' + role.name + '</span>' +
            '<small class="text-muted">' + role.description + '</small>' +
            '</div>';
        }).join('');
      } else {
        rolesContainer.innerHTML = '<span class="text-muted">Nessun ruolo assegnato</span>';
      }
    } catch (error) {
      showAlert('Errore nel caricamento del profilo: ' + error.message, 'danger');
    }
  }

  // --- Submit: Modifica Username ---

  document.getElementById('formUsername').addEventListener('submit', async function(e) {
    e.preventDefault();
    const newUsername = document.getElementById('newUsername').value.trim();
    const currentPassword = document.getElementById('pwdForUsername').value;

    if (!newUsername || newUsername.length < 3) {
      showAlert('Il nuovo username deve contenere almeno 3 caratteri.', 'warning');
      return;
    }
    if (!/^[a-zA-Z0-9_-]+$/.test(newUsername)) {
      showAlert('Il nuovo username può contenere solo lettere, numeri, underscore e trattini.', 'warning');
      return;
    }
    if (!currentPassword) {
      showAlert('Inserisci la password attuale per confermare.', 'warning');
      return;
    }

    try {
      const response = await fetch('/' + apiPrefix + '/adminUsers/updateUserProfile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newUsername: newUsername, currentPassword: currentPassword })
      });
      const result = await response.json();

      if (response.ok && result.success) {
        if (result.requireRelogin) {
          showAlert(result.success, 'success');
          setTimeout(function() { window.location.href = loginUrl; }, 2000);
        } else {
          showAlert(result.success, 'success');
          document.getElementById('formUsername').reset();
          loadProfile();
        }
      } else if (result.error) {
        showAlert(result.error, 'danger');
        if (result.errorField) {
          const field = document.getElementById(result.errorField);
          if (field) { field.classList.add('is-invalid'); field.focus(); setTimeout(function() { field.classList.remove('is-invalid'); }, 3000); }
        }
      }
    } catch (error) {
      showAlert('Errore nella modifica dell\'username: ' + error.message, 'danger');
    }
  });

  // --- Submit: Modifica Email ---

  document.getElementById('formEmail').addEventListener('submit', async function(e) {
    e.preventDefault();
    const newEmail = document.getElementById('newEmail').value.trim();
    const currentPassword = document.getElementById('pwdForEmail').value;

    if (!newEmail) {
      showAlert('Inserisci la nuova email.', 'warning');
      return;
    }
    if (!currentPassword) {
      showAlert('Inserisci la password attuale per confermare.', 'warning');
      return;
    }

    try {
      const response = await fetch('/' + apiPrefix + '/adminUsers/updateUserProfile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newEmail: newEmail, currentPassword: currentPassword })
      });
      const result = await response.json();

      if (response.ok && result.success) {
        showAlert(result.success, 'success');
        document.getElementById('formEmail').reset();
        loadProfile();
      } else if (result.error) {
        showAlert(result.error, 'danger');
        if (result.errorField) {
          const field = document.getElementById(result.errorField);
          if (field) { field.classList.add('is-invalid'); field.focus(); setTimeout(function() { field.classList.remove('is-invalid'); }, 3000); }
        }
      }
    } catch (error) {
      showAlert('Errore nella modifica dell\'email: ' + error.message, 'danger');
    }
  });

  // --- Submit: Modifica Password ---

  document.getElementById('formPassword').addEventListener('submit', async function(e) {
    e.preventDefault();
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const currentPassword = document.getElementById('pwdForPassword').value;

    if (!newPassword || newPassword.length < 6) {
      showAlert('La nuova password deve contenere almeno 6 caratteri.', 'warning');
      return;
    }
    if (newPassword !== confirmPassword) {
      showAlert('Le password non coincidono.', 'warning');
      document.getElementById('confirmPassword').focus();
      return;
    }
    if (!currentPassword) {
      showAlert('Inserisci la password attuale per confermare.', 'warning');
      return;
    }

    try {
      const response = await fetch('/' + apiPrefix + '/adminUsers/updateUserProfile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ newPassword: newPassword, currentPassword: currentPassword })
      });
      const result = await response.json();

      if (response.ok && result.success) {
        showAlert(result.success, 'success');
        document.getElementById('formPassword').reset();
      } else if (result.error) {
        showAlert(result.error, 'danger');
        if (result.errorField) {
          const field = document.getElementById(result.errorField);
          if (field) { field.classList.add('is-invalid'); field.focus(); setTimeout(function() { field.classList.remove('is-invalid'); }, 3000); }
        }
      }
    } catch (error) {
      showAlert('Errore nella modifica della password: ' + error.message, 'danger');
    }
  });

  // --- Caricamento iniziale ---
  document.addEventListener('DOMContentLoaded', loadProfile);
</script>
<% } %>

</body>
</html>
